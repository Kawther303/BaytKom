{% extends 'base.html' %}

{% block content %}

<h1> Booking Details </h1>

  <div class="card">
      {% load static %}
      <img width="350px" height="350px" src="{% static room.image|cut:'main_app/static/' %}" class="imgsize"/>
      <div class="flex-container"></div>
    <div class="card-content">
      <span class="card-title">{{ room.name }}</span>
      <p>Description: {{ room.description }}</p>
      <p>roomType:  {{room.roomType}}</p>
      <p>size:  {{room.size}}</p>
      <p>Price: BD <span><input id="room_price" value="{{room.price}}"></input></span></p>
      
      <div>
  
        </div>
      </div>
    </div>

    <form method="GET" action="{% url 'check_availability' room.id %}">
      {% csrf_token %}
      room: {{ room.id }}<br>
      Check-in:<input type='text' id='check_in' name='check_in' value="{{ R_check_in }}">
      Check-Out:<input type='text' id='check_out' name='check_out' value="{{ R_check_out }}">
<br>
      <p id="date_note" class="red-text"></p><br>

      <input type="submit" value="Check Availability">
    </form>

  R_check: {{ R_check  }} -  {{ R_check_in  }}  -  {{ R_check_out  }} 
  {% if R_check  %}
    <div class="card-panel teal-text center-align" > 
      {{ room.name }} is available for today!
    </div>
  {% else %}
    <div class="card-panel red-text center-align">
    {{room.name}} has already booked for today! 
    </div>
  {% endif %}


    <div>  <form method="post" action="{% url 'add_booking' room.id user.id %}">
      {% csrf_token %}
        <input type="hidden" id="id_from_date" name="from_date" >
       <input type="hidden" id="id_to_date" name="to_date" >
     <br>

      <h5>No of nights: <span id="night_result"></span></h5><br>
      <h5>Total Price : BD <span id="price_result" class="red-text"></span></h5> <br>
       <input  type="hidden" id="price" name="price">
      <hr>
      <h3> Guest Details:</h3>
      Guest Name:   <input type="text" id="gues_name" name="guest_name" value="{{user.full_name}}"><br>
      Guest Email:   <input type="email" id="gues_email" name="guest_email" value="{{user.email}}"><br>
      Guest Phone:   <input type="text" id="guest_mobile" name="guest_mobile" value="{{user.phone_number}}"><br>


      <input id="book_btn" type="submit" class="btn" value="Place Booking">
        </form></div>

    
  <script>
    
    let differenceInDays
    let fromDateEle = document.getElementById('check_in');
    let toDateEle = document.getElementById('check_out');
   
    M.Datepicker.init(fromDateEle, {format: 'yyyy-mm-dd',   defaultDate: new Date(new Date().getTime() + 24 * 60 * 60 * 1000),
      setDefaultDate: false,
      autoClose: true
    })  

    M.Datepicker.init(toDateEle, {format: 'yyyy-mm-dd',   defaultDate: new Date(new Date().getTime() + 48 * 60 * 60 * 1000),
      setDefaultDate: false,
      autoClose: true
    })  
    const booking_btn = document.getElementById('book_btn');
    let priceEle = document.getElementById('id_price');
    let note = document.getElementById("date_note"); 
    let n_resultElement = document.getElementById('night_result');
    let p_resultElement = document.getElementById('price_result');
    let room_p = document.getElementById('room_price').value;

    

    const calculateDifference=()=> {
     
      const date1 = new Date(fromDateEle.value);
      const date2 = new Date(toDateEle.value);
      const today = new Date();

      if (date1 >= date2 || date1 < today-1){
        fromDateEle.innerText = '';
        toDateEle.innerText = '';
        note.innerText = 'Invalid Dates';
        booking_btn.disabled = true; 

      } else {
        
        document.getElementById('id_from_date').value = date1;
        document.getElementById('id_to_date').value = date2;

        note.innerText = '';
        booking_btn.disabled = false; 
      }

      if (date1 && date2) {
       
        const differenceInTime = date2.getTime() - date1.getTime();
         differenceInDays = differenceInTime / (1000 * 3600 * 24);
        n_resultElement.textContent = ` ${differenceInDays} nights.`;
        the_price = differenceInDays * room_p;
        p_resultElement.textContent = the_price;
        document.getElementById('price').value = the_price;
      }else{
        n_resultElement.textContent = '';
        p_resultElement.textContent = '';
      }
    }
  
    const checkTheDates=()=>{
      if (fromDateEle && toDateEle){
        const i = 0
      }else{
        fromDateEle.value = new Date(new Date().getTime() + 24 * 60 * 60 * 1000);
        toDateEle.value = new Date(new Date().getTime() + 48 * 60 * 60 * 1000)
      }
    }

    fromDateEle.addEventListener('click', calculateDifference);
    toDateEle.addEventListener('mouseover', calculateDifference);

    </script>
{% endblock %}